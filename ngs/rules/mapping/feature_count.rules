#############################################################################
#          Rules for counting.                                              #
#                                                                           #
# Date: 23.06.2015                                                          #
#                                                                           #
#############################################################################

rule feature_count:
    """Assigns counts to annotated features using name sorted BAMs."""
    input: bams = expand("results/mapping/{{reference}}/{{kind}}/{unit}_name.bam", unit = config["units"].keys() ) ,
           gtf = lambda wildcards: config["ref_dir"] + config["features"][wildcards.features]
    output: "results/de/{reference}/{kind}/{features}.counts"
    threads: 20
    params: feature = config["features"]["type"]
    shell: "/usr/local/bin/subread-1.4.6/bin/featureCounts -T {threads} -p -t exon -g {params.feature} -a {input.gtf} -o {output} {input.bams}"
    
# not tested until now
rule count_mapped_sequences:
    """Counts how often a sequence was mapped by reads."""
    input: bams = expand("results/mapping/{{reference}}/{{kind}}/{unit}_name.bam", unit = config["units"].keys() ) ,
    output: "results/de/{reference}/{kind}/{unit}.counts"
    shell: "samtools view -F 4 {input} | cut -f 3 | sort | uniq -c | sed 's/^[ \t]*//;s/[ \t]*$//' > {output}"
