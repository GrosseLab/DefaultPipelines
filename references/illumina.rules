#############################################################################
#          Script to generate reference data provided by illumina.          #
#                                                                           #
# Date: 02.01.2015                                                          #
#                                                                           #
# Example usage: snakemake --snakefile illumina.rules                       #
#############################################################################

ILLUMINA_URL = "http://support.illumina.com/content/dam/illumina-support/documents"

## KITS

# trusight one kit

rule trusight_one_hg37_manifest:
    """
    Downloads trusight one kit manifest, clean up and extend target regions.
    Current Illumina versino is based on hg19
    """
    output: config["ref_dir"] + "/illumina/hg37/kits/trusightone.bed"
    shell: """
    wget -q -O - {ILLUMINA_URL}/downloads/productfiles/trusight/trusight-one-bed-may-2014.zip | gunzip -cd > |
    sed 's/\.chr[1-9,X,Y]\+//' |
    sed 's/\./-/g' | 
    awk '{{print $1\"\t\"$2-20\"\t\"$3+20\"\t\"$4}}' > {output}
    """

# trusight cancer kit

rule trusight_cancer_hg37_manifest:
    """
    Downloads trusight cancer kit manifest, clean up and extend target regions. 
    Current Illumina version is based hg19.
    """
    output: config["ref_dir"] + "/illumina/hg37/kits/trusightcancer.bed"
    shell: """
    wget -q -O - {ILLUMINA_URL}/documentation/chemistry_documentation/trusight/trusight_cancer_manifest_a.bed | 
    sed 's/\.chr[1-9,X,Y]\+//' |
    sed 's/\./-/g' | 
    awk '{{print $1\"\t\"$2-20\"\t\"$3+20\"\t\"$4}}' > {output}
    """

rule lift_manifest_from_hg37_to_hg38:
    "Lifts hg37 coordinates to hg38"
    input: bed = config["ref_dir"] + "/illumina/hg37/kits/{manifest}.bed",
           chain = config["ref_dir"] + "/human/hg37/chains/hg19ToHg38.over.chain"
    output: bed = config["ref_dir"] + "/illumina/hg38/kits/{manifest}.bed",
            unmapped = config["ref_dir"] + "/illumina/hg38/kits/{manifest}.bed"
    shell: "/usr/local/bin/liftOver/liftOver {input.bed} {input.chain} {output.bed} {output.unmapped}"
    

